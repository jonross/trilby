#!/bin/sh

export PROJECT_DIR=$(dirname $0)/..

if [ ! -e $PROJECT_DIR/target/start ]; then
    echo "$PROJECT_DIR/target/start" is missing >&2
    echo "You probably forgot to run 'sbt start-script'" >&2
    exit 1
fi

# 'sbt start-script' exports a broken shell command under OS/X so override
# its setting of PROJECT_DIR

sed -i -e '/^PROJECT_DIR=/s/^/#/' $PROJECT_DIR/target/start

export JAVA_OPTS=""

verbose_gc=false
gc_details=true
need_gc=true
use_jline=true
gen_heap=false

while true; do case "$1" in
    --genheap)
        gen_heap=true
        shift
        ;;
    --hprof)
        JAVA_OPTS+=" -agentlib:hprof=cpu=samples,depth=35,interval=5"
        shift
        ;;
    --g1)
        JAVA_OPTS+=" -XX:+UnlockExperimentalVMOptions -XX:+UseG1GC"
        gc_details=false
        need_gc=false
        shift
        ;;
    --gc)
        verbose_gc=true
        shift
        ;;
    --nojline)
        use_jline=false
        shift
        ;;
    --*)
        break
        ;;
    -*)
        JAVA_OPTS+=" $1"
        shift
        ;;
    *)
        break
        ;;
esac; done

if $verbose_gc; then
    JAVA_OPTS+=" -verbose:gc"
    if $gc_details; then
        JAVA_OPTS+=" -XX:+PrintGCDetails"
    fi
fi

if $need_gc; then
    JAVA_OPTS+=" -XX:+UseConcMarkSweepGC"
fi

if $gen_heap; then
    $PROJECT_DIR/target/start trilby.util.GenHeap "$@" &
    sleep 1
    pid=$(jps -l | awk '$2 == "trilby.util.GenHeap" { print $1; }')
    rm -f genheap.hprof
    jmap -dump:format=b,file=genheap.hprof $pid
    kill $pid
else
    exec $PROJECT_DIR/target/start trilby.main.Main "$@"
fi



